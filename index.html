<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>もしもボックスAI | Parallel Universe Simulator</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React, ReactDOM, Babel for Browser-side JSX -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap');
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #05070a;
            color: #f1f5f9;
            overflow-x: hidden;
        }
        .animate-spin-slow {
            animation: spin 40s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0f172a;
        }
        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // --- API Key Management ---
        const apiKey = ""; 

        // --- Lucide Icon Component Helper ---
        // Uses innerHTML and ref to avoid "removeChild" errors caused by Lucide replacing DOM nodes outside React's control.
        const Icon = ({ name, size = 24, className = "" }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (window.lucide && containerRef.current) {
                    containerRef.current.innerHTML = `<i data-lucide="${name}" style="width: ${size}px; height: ${size}px" class="${className}"></i>`;
                    window.lucide.createIcons({
                        attrs: { 'stroke-width': 2 },
                        nameAttr: 'data-lucide'
                    });
                }
            }, [name, size, className]);
            return <span ref={containerRef} className="inline-flex items-center justify-center flex-shrink-0"></span>;
        };

        const App = () => {
            const [input, setInput] = useState("");
            const [loading, setLoading] = useState(false);
            const [worldData, setWorldData] = useState(null);
            const [error, setError] = useState(null);
            const [images, setImages] = useState({});
            const [showSettings, setShowSettings] = useState(false);
            const [storedKey, setStoredKey] = useState(localStorage.getItem('moshimo_api_key') || "");
            const [tempKey, setTempKey] = useState(localStorage.getItem('moshimo_api_key') || "");

            const getActiveKey = () => apiKey || storedKey || "";

            const categories = [
                { id: 'politics', label: '政治', icon: 'gavel', color: 'from-blue-600/20 to-indigo-600/20' },
                { id: 'economy', label: '経済', icon: 'trending-up', color: 'from-emerald-600/20 to-teal-600/20' },
                { id: 'medical', label: '医療', icon: 'heart-pulse', color: 'from-rose-600/20 to-pink-600/20' },
                { id: 'education', label: '教育', icon: 'graduation-cap', color: 'from-amber-600/20 to-orange-600/20' },
                { id: 'lifestyle', label: '衣食住', icon: 'home', color: 'from-cyan-600/20 to-sky-600/20' },
                { id: 'energy', label: 'エネルギー', icon: 'zap', color: 'from-yellow-600/20 to-orange-500/20' },
                { id: 'sports', label: 'スポーツ', icon: 'trophy', color: 'from-purple-600/20 to-violet-600/20' },
                { id: 'music', label: '音楽', icon: 'music', color: 'from-fuchsia-600/20 to-pink-500/20' },
                { id: 'romance', label: '恋愛', icon: 'heart', color: 'from-red-600/20 to-rose-500/20' }
            ];

            const suggestions = [
                "もしも、テレパシーが普及していたら？",
                "もしも、バブルが崩壊していなければ？",
                "もしも、インターネットが存在しなかったら？",
                "もしも、人間の寿命が30歳までだったら？"
            ];

            const saveSettings = () => {
                localStorage.setItem('moshimo_api_key', tempKey);
                setStoredKey(tempKey);
                setShowSettings(false);
            };

            const generateImage = async (id, prompt) => {
                let retries = 0;
                const maxRetries = 5;
                const backoffDelays = [1000, 2000, 4000, 8000, 16000];
                const key = getActiveKey();

                while (retries < maxRetries) {
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${key}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                instances: { prompt: `Cinematic high-detail photorealistic scene of: ${prompt}. Cinematic lighting, 8k resolution, realistic textures, no text.` },
                                parameters: { sampleCount: 1 }
                            })
                        });

                        if (!response.ok) {
                            if (response.status === 429) throw new Error("RATE_LIMIT");
                            throw new Error(`API_ERROR: ${response.status}`);
                        }

                        const result = await response.json();
                        const base64 = result.predictions?.[0]?.bytesBase64Encoded;
                        
                        if (base64) {
                            setImages(prev => ({ ...prev, [id]: `data:image/png;base64,${base64}` }));
                            return;
                        }
                    } catch (err) {
                        if (retries === maxRetries - 1) return;
                        await new Promise(res => setTimeout(res, backoffDelays[retries]));
                        retries++;
                    }
                }
            };

            const generateWorld = async (userPrompt) => {
                setLoading(true);
                setError(null);
                setImages({});
                setWorldData(null);
                const key = getActiveKey();

                if (!key) {
                    setError("APIキーが設定されていません。右上の設定ボタンからAPIキーを入力してください。");
                    setLoading(false);
                    return;
                }

                const systemPrompt = `あなたは歴史シミュレーター「もしもボックスAI」です。
ユーザーが入力した歴史の分岐点に基づき、その並行世界における2026年の社会状況をシミュレートしてください。

出力は必ず以下の9つのカテゴリー全てを含める必要があります：
政治、経済、医療、教育、衣食住、エネルギー、スポーツ、音楽、恋愛。

各項目について、具体的で納得感のある変化を日本語で記述してください。
また、topics配列にはこの世界の2026年に起きた歴史的な大事件を3つ作成してください。
imagePromptは、画像生成AIのための英語の詳細な指示（プロンプト）にしてください。`;

                const payload = {
                    contents: [{ parts: [{ text: `「もしも、${userPrompt}」という設定で、2026年の並行世界を生成して。全てのカテゴリー項目をもれなく回答してください。` }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: { 
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            required: ["realityDeviation", "worldSummary", "categories", "topics"],
                            properties: {
                                realityDeviation: { type: "NUMBER" },
                                worldSummary: { type: "STRING" },
                                categories: {
                                    type: "OBJECT",
                                    required: ["politics", "economy", "medical", "education", "lifestyle", "energy", "sports", "music", "romance"],
                                    properties: {
                                        politics: { type: "OBJECT", properties: { content: { type: "STRING" } }, required: ["content"] },
                                        economy: { type: "OBJECT", properties: { content: { type: "STRING" } }, required: ["content"] },
                                        medical: { type: "OBJECT", properties: { content: { type: "STRING" } }, required: ["content"] },
                                        education: { type: "OBJECT", properties: { content: { type: "STRING" } }, required: ["content"] },
                                        lifestyle: { type: "OBJECT", properties: { content: { type: "STRING" } }, required: ["content"] },
                                        energy: { type: "OBJECT", properties: { content: { type: "STRING" } }, required: ["content"] },
                                        sports: { type: "OBJECT", properties: { content: { type: "STRING" } }, required: ["content"] },
                                        music: { type: "OBJECT", properties: { content: { type: "STRING" } }, required: ["content"] },
                                        romance: { type: "OBJECT", properties: { content: { type: "STRING" } }, required: ["content"] }
                                    }
                                },
                                topics: {
                                    type: "ARRAY",
                                    minItems: 3,
                                    maxItems: 3,
                                    items: {
                                        type: "OBJECT",
                                        required: ["title", "detail", "imagePrompt"],
                                        properties: { 
                                            title: { type: "STRING" }, 
                                            detail: { type: "STRING" }, 
                                            imagePrompt: { type: "STRING" } 
                                        }
                                    }
                                }
                            }
                        }
                    }
                };

                const backoffDelays = [1000, 2000, 4000, 8000, 16000];
                let retries = 0;
                const maxRetries = 5;

                while (retries < maxRetries) {
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            if (response.status === 403 || response.status === 401) throw new Error("認証エラー: APIキーが正しくありません。");
                            throw new Error(`API接続エラー: ${response.status}`);
                        }

                        const result = await response.json();
                        const rawText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (!rawText) throw new Error("AIの応答が空です。");

                        const data = JSON.parse(rawText);
                        setWorldData(data);
                        setLoading(false);

                        // Start image generation for topics with clear interval to avoid 429 errors
                        if (data.topics) {
                            data.topics.forEach((topic, idx) => {
                                if (topic.imagePrompt) {
                                    // Use staggered start times (1.5s gap)
                                    setTimeout(() => {
                                        generateImage(`topic_${idx}`, topic.imagePrompt);
                                    }, idx * 1500);
                                }
                            });
                        }
                        return;
                    } catch (err) {
                        if (retries === maxRetries - 1) {
                            setError(`データの解析に失敗しました。再試行してください。\n詳細: ${err.message}`);
                            setLoading(false);
                            return;
                        }
                        await new Promise(res => setTimeout(res, backoffDelays[retries]));
                        retries++;
                    }
                }
            };

            const handleSumbit = (e) => {
                e.preventDefault();
                if (!input.trim() || loading) return;
                generateWorld(input);
            };

            const SkeletonImage = () => (
                <div className="w-full h-full bg-slate-800/50 animate-pulse flex flex-col items-center justify-center gap-4">
                    <Icon name="cpu" size={48} className="text-cyan-500 animate-spin" />
                    <span className="text-xs font-mono text-slate-500 uppercase tracking-widest">Generating Reality...</span>
                </div>
            );

            return (
                <div className="min-h-screen text-slate-100 flex flex-col">
                    <div className="fixed inset-0 pointer-events-none -z-10 overflow-hidden">
                        <div className="absolute top-[-5%] left-[-10%] w-[50%] h-[50%] bg-cyan-900/10 blur-[120px] rounded-full"></div>
                        <div className="absolute bottom-[-5%] right-[-10%] w-[50%] h-[50%] bg-blue-900/10 blur-[120px] rounded-full"></div>
                    </div>

                    <header className="border-b border-white/5 bg-slate-950/80 backdrop-blur-3xl sticky top-0 z-50 flex-shrink-0">
                        <div className="max-w-6xl mx-auto px-6 py-3 flex justify-between items-center">
                            <div className="flex items-center gap-3 group cursor-pointer" onClick={() => { setWorldData(null); setInput(""); setError(null); setLoading(false); }}>
                                <div className="bg-cyan-600 p-1.5 rounded-lg shadow-[0_0_15px_rgba(6,182,212,0.4)] transition-transform group-hover:scale-110">
                                    <Icon name="zap" size={18} className="text-white" />
                                </div>
                                <h1 className="text-lg font-black tracking-tight text-white">もしもボックス<span className="text-cyan-500">AI</span></h1>
                            </div>
                            <div className="flex items-center gap-4">
                                <div className="hidden md:block text-[9px] font-mono text-slate-500 uppercase tracking-[0.2em] bg-white/5 px-3 py-1 rounded-full border border-white/5">
                                    Reality Engine v3.12
                                </div>
                                <button onClick={() => setShowSettings(true)} className="text-slate-400 hover:text-white transition-colors p-1">
                                    <Icon name="settings" size={20} />
                                </button>
                            </div>
                        </div>
                    </header>

                    {showSettings && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                            <div className="bg-slate-900 border border-slate-700 w-full max-w-md p-8 rounded-[2.5rem] shadow-2xl">
                                <h3 className="text-2xl font-black mb-4 flex items-center gap-3">
                                    <Icon name="settings" size={24} className="text-cyan-500" /> API設定
                                </h3>
                                <p className="text-slate-400 text-sm mb-6 leading-relaxed">
                                    GitHub Pagesなどで実行する場合は、Google AI Studioで取得したAPIキーを入力してください。<br/>
                                </p>
                                <input type="password" value={tempKey} onChange={(e) => setTempKey(e.target.value)} placeholder="AIza..." className="w-full bg-black border border-slate-700 rounded-xl px-4 py-3 mb-6 focus:outline-none focus:border-cyan-500 text-cyan-400 font-mono" />
                                <div className="flex gap-3">
                                    <button onClick={() => setShowSettings(false)} className="flex-1 px-4 py-3 rounded-xl bg-slate-800 hover:bg-slate-700 transition-colors font-bold text-white">キャンセル</button>
                                    <button onClick={saveSettings} className="flex-1 px-4 py-3 rounded-xl bg-cyan-600 hover:bg-cyan-500 transition-colors font-bold text-white">保存する</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <main className={`max-w-6xl mx-auto px-6 flex-grow flex flex-col ${!worldData && !loading ? 'justify-center overflow-hidden h-[calc(100vh-60px)]' : 'py-10'}`}>
                        {!worldData && !loading ? (
                            <div className="animate-in fade-in slide-in-from-bottom-4 duration-1000 w-full max-w-4xl mx-auto flex flex-col items-center">
                                <div className="mb-4 p-4 bg-cyan-500/5 rounded-full border border-cyan-500/10 shadow-2xl">
                                    <Icon name="globe" size={48} className="text-cyan-500 animate-spin-slow" />
                                </div>
                                <h2 className="text-3xl md:text-5xl font-black mb-3 tracking-tight text-white text-center text-balance leading-tight">歴史の分岐点を観測する</h2>
                                <p className="text-slate-400 mb-6 max-w-2xl mx-auto text-base md:text-lg text-center leading-snug">あなたの「もしも」から生まれる、もう一つの2026年を可視化します。</p>
                                <form onSubmit={handleSumbit} className="relative w-full max-w-2xl mb-8 group">
                                    <div className="absolute -inset-1 bg-gradient-to-r from-cyan-600 to-blue-600 rounded-[2rem] blur opacity-15 group-hover:opacity-30 transition duration-700"></div>
                                    <input type="text" value={input} onChange={(e) => setInput(e.target.value)} placeholder="もしも、○○だったら？" className="relative w-full bg-slate-900/90 border border-white/10 rounded-[2rem] px-8 py-5 text-lg focus:outline-none focus:border-cyan-500 transition-all shadow-xl text-white" />
                                    <button type="submit" disabled={loading} className="absolute right-2.5 top-2.5 bottom-2.5 bg-cyan-600 hover:bg-cyan-500 text-white px-8 rounded-2xl transition-all flex items-center justify-center shadow-lg active:scale-95 font-black text-base disabled:opacity-50">観測開始 <Icon name="send" size={18} className="ml-2" /></button>
                                </form>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3 text-left w-full max-w-2xl">
                                    {suggestions.map((suggestion, i) => (
                                        <button key={i} onClick={() => setInput(suggestion)} className="p-3.5 bg-slate-900/40 border border-white/5 rounded-2xl hover:border-cyan-500/30 transition-all text-xs md:text-sm text-slate-400 flex items-center justify-between group hover:bg-slate-800/60 font-medium truncate">
                                            {suggestion} <Icon name="chevron-right" size={16} className="text-slate-700 group-hover:text-cyan-500 flex-shrink-0" />
                                        </button>
                                    ))}
                                </div>
                            </div>
                        ) : loading ? (
                            <div className="flex-grow flex flex-col items-center justify-center animate-in fade-in">
                                <div className="relative mb-10">
                                    <div className="w-32 h-32 border-[5px] border-cyan-500/10 border-t-cyan-500 rounded-full animate-spin"></div>
                                    <div className="absolute inset-0 flex items-center justify-center">
                                        <Icon name="cpu" size={48} className="text-cyan-500 animate-pulse" />
                                    </div>
                                </div>
                                <h3 className="text-2xl font-black text-white mb-2 tracking-widest text-center uppercase">Simulating the Paradox...</h3>
                                <p className="text-slate-500 font-mono text-xs tracking-[0.4em] uppercase text-center">Mapping the Multiverse</p>
                            </div>
                        ) : (
                            <div className="animate-in fade-in duration-1000 pb-20">
                                {/* Summary Section */}
                                <div className="bg-gradient-to-br from-slate-900 to-[#0d1117] border border-white/10 rounded-[3rem] p-8 md:p-12 mb-12 shadow-2xl flex flex-col md:flex-row items-center gap-8 md:gap-14 relative overflow-hidden">
                                   <div className="absolute top-0 right-0 p-12 opacity-[0.03] pointer-events-none scale-150">
                                       <Icon name="layout-grid" size={240} />
                                   </div>
                                   <div className="flex-shrink-0 text-center md:text-left relative z-10">
                                      <div className="text-xs font-black text-cyan-500 uppercase tracking-[0.3em] mb-2">Reality Deviation</div>
                                      <div className="text-7xl font-black text-white font-mono leading-none">{worldData.realityDeviation || 0}<span className="text-3xl ml-1">%</span></div>
                                   </div>
                                   <div className="h-px md:h-24 w-full md:w-px bg-white/10"></div>
                                   <div className="flex-1 relative z-10">
                                      <h3 className="text-sm font-bold text-slate-500 uppercase tracking-[0.3em] mb-4 flex items-center gap-3">
                                          <Icon name="info" size={16} className="text-cyan-600" /> シミュレーション報告: 2026年
                                      </h3>
                                      <p className="text-2xl md:text-3xl font-bold leading-tight text-slate-100">{worldData.worldSummary}</p>
                                   </div>
                                </div>

                                {/* Fields Analysis Section */}
                                <div className="flex items-end justify-between mb-8 px-2">
                                   <h4 className="text-base font-black text-white uppercase tracking-[0.4em] border-l-4 border-cyan-600 pl-4">分野別解析</h4>
                                   <span className="text-slate-600 text-[10px] font-mono uppercase">System Observables</span>
                                </div>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-20">
                                  {categories.map((cat) => (
                                    <div key={cat.id} className="bg-slate-900/40 border border-white/5 rounded-[2rem] overflow-hidden hover:border-cyan-500/40 transition-all flex flex-col group shadow-xl">
                                      <div className={`h-24 bg-gradient-to-br ${cat.color} flex items-center justify-center border-b border-white/5`}>
                                        <Icon name={cat.icon} size={40} className="text-white drop-shadow-lg" />
                                      </div>
                                      <div className="p-8 flex-1">
                                        <div className="flex items-center gap-3 mb-4">
                                          <span className="font-black text-lg text-white tracking-tight">{cat.label}</span>
                                        </div>
                                        <p className="text-lg text-slate-300 leading-relaxed font-medium">
                                          {worldData.categories?.[cat.id]?.content || "この世界のデータは観測できませんでした。"}
                                        </p>
                                      </div>
                                    </div>
                                  ))}
                                </div>

                                {/* Key Events Section (WITH IMAGES) */}
                                <div className="flex items-end justify-between mb-8 px-2">
                                   <h4 className="text-base font-black text-white uppercase tracking-[0.4em] border-l-4 border-orange-600 pl-4">歴史的トピックス</h4>
                                   <span className="text-slate-600 text-[10px] font-mono uppercase">Critical Events</span>
                                </div>

                                <div className="space-y-12 mb-20">
                                  {worldData.topics?.map((topic, idx) => (
                                    <div key={idx} className="bg-slate-900/20 border border-white/5 rounded-[3.5rem] p-6 md:p-10 flex flex-col lg:flex-row gap-10 items-start group overflow-hidden relative shadow-2xl min-h-[400px]">
                                      <div className="w-full lg:w-[400px] aspect-square overflow-hidden rounded-[2.5rem] shadow-2xl flex-shrink-0 relative bg-slate-950">
                                        {images[`topic_${idx}`] ? (
                                          <img src={images[`topic_${idx}`]} alt={topic.title} className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-1000 animate-in fade-in" />
                                        ) : (
                                          <SkeletonImage />
                                        )}
                                      </div>
                                      <div className="flex-1 pt-4">
                                        <div className="inline-block bg-orange-600/10 text-orange-500 text-[10px] font-black px-4 py-1 rounded-full border border-orange-600/20 mb-5 uppercase tracking-[0.2em]">TOPIC OBSERVED #{idx + 1}</div>
                                        <h5 className="text-3xl md:text-4xl font-black text-white mb-6 group-hover:text-cyan-400 transition-colors leading-tight">{topic.title}</h5>
                                        <p className="text-xl md:text-2xl text-slate-300 leading-relaxed font-medium">{topic.detail}</p>
                                      </div>
                                      <div className="absolute -bottom-10 -right-10 text-white/[0.02] pointer-events-none">
                                          <Icon name="lightbulb" size={240} />
                                      </div>
                                    </div>
                                  ))}
                                </div>
                                
                                <button onClick={() => { setWorldData(null); setInput(""); setImages({}); setError(null); setLoading(false); }} className="w-full py-10 border-4 border-dashed border-white/10 rounded-[3rem] text-slate-500 font-black text-lg uppercase tracking-[0.3em] hover:text-cyan-400 hover:border-cyan-500/50 hover:bg-cyan-500/5 transition-all flex items-center justify-center gap-4 group text-white">
                                    <Icon name="refresh-cw" size={24} className="group-hover:rotate-180 transition-transform duration-1000 mr-4" /> 新しい世界線を観測
                                </button>
                            </div>
                        )}

                        {error && (
                            <div className="mt-8 p-6 bg-red-500/5 border border-red-500/20 rounded-[2rem] text-red-400 flex flex-col gap-4 shadow-2xl animate-in slide-in-from-top-4">
                                <div className="flex items-center gap-5">
                                    <Icon name="alert-triangle" size={28} />
                                    <div className="text-lg font-bold">観測エラー</div>
                                </div>
                                <div className="whitespace-pre-wrap font-mono text-sm opacity-80">{error}</div>
                                <div className="flex gap-4 mt-2">
                                    <button onClick={() => setShowSettings(true)} className="bg-cyan-600/20 hover:bg-cyan-600/40 text-cyan-400 px-6 py-2 rounded-xl transition-colors font-bold">APIキーを確認</button>
                                    <button onClick={() => { setWorldData(null); setError(null); setLoading(false); }} className="bg-red-500/20 hover:bg-red-500/40 text-red-400 px-6 py-2 rounded-xl transition-colors font-bold text-white">トップへ戻る</button>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
